<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seleccionar Cuenta - EurekaBank</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#14532d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EurekaBank">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/img/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- StompJS para WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>

<body class="min-h-screen flex flex-col font-['Poppins']">

    <nav class="bg-green-900 p-3 sm:p-4 text-white">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center gap-2 sm:gap-0">
            <span class="font-bold text-xl sm:text-2xl">EurekaBank</span>
            <div class="flex items-center space-x-4">
                <span class="text-xs sm:text-sm"><i class="fas fa-user-tie mr-1"></i> Cajero: <span th:text="${cajeroNombre}" class="font-semibold">Cajero</span></span>
            </div>
        </div>
    </nav>

    <main class="container mx-auto flex items-center justify-center flex-1 py-8 px-4">

        <div class="max-w-3xl w-full bg-green-500 rounded-xl sm:rounded-2xl p-4 sm:p-8 shadow-xl">
            <div class="flex items-center justify-between mb-4">
                <a th:href="@{/cajeros}" onclick="liberarCajero()" class="text-gray-700 hover:text-gray-900 transition text-sm sm:text-base">
                    <i class="fas fa-arrow-left mr-1 sm:mr-2"></i> <span class="hidden sm:inline">Cambiar Cajero</span><span class="sm:hidden">Atrás</span>
                </a>
            </div>
            
            <h2 class="text-xl sm:text-3xl font-bold mb-4 text-gray-800 text-center">Seleccionar Cuenta</h2>
            <p class="mb-2 text-gray-700 text-center">Usuario: <span th:text="${usuarioLogueado}" class="font-semibold">Usuario</span></p>
            <p class="mb-6 text-gray-600 text-center">Por favor, selecciona la cuenta con la que deseas operar:</p>
            <hr class="mb-6 border-gray-200" />

            <!-- Mensaje de error si existe -->
            <div th:if="${error != null}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
                <p th:text="${error}">Error</p>
            </div>

            <!-- Lista de cuentas - responsive -->
            <div th:if="${cuentas != null and !cuentas.isEmpty()}" class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                <a th:each="cuenta : ${cuentas}" 
                   th:href="@{/seleccionarCuenta(cuenta=${cuenta})}"
                   class="p-5 flex items-center bg-white rounded-lg shadow-md hover:shadow-xl hover:scale-102 transition transform cursor-pointer border-l-4 border-blue-500">
                    <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-credit-card text-blue-600 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <span class="block font-semibold text-gray-800 text-lg">Cuenta</span>
                        <span class="text-gray-600 font-mono" th:text="${cuenta}">000000000000</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </a>
            </div>

            <!-- Mensaje si no hay cuentas -->
            <div th:if="${cuentas == null or cuentas.isEmpty()}" class="text-center py-8">
                <i class="fas fa-inbox text-gray-400 text-5xl mb-4"></i>
                <p class="text-gray-600">No se encontraron cuentas disponibles.</p>
            </div>

            <form th:action="@{/logout}" method="post" class="mt-8 text-center">
                <button type="submit" onclick="liberarCajero()"
                    class="text-sm text-gray-600 hover:text-gray-800 font-medium transition duration-150">
                    <i class="fas fa-sign-out-alt mr-1"></i> Cerrar Sesión
                </button>
            </form>
        </div>
    </main>

    <script>
        // Variables globales
        let stompClient = null;
        let sessionId = localStorage.getItem('wsSessionId');
        
        // Conectar al WebSocket para mantener la sesión viva
        function conectarWebSocket() {
            const wsUrl = 'ws://' + window.location.host + '/ws-eureka';
            
            stompClient = new StompJs.Client({
                brokerURL: wsUrl,
                debug: function (str) {
                    console.log('STOMP: ' + str);
                },
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000,
            });

            stompClient.onConnect = function (frame) {
                console.log('Conectado: ' + frame);
                // Registrar la sesión
                stompClient.publish({
                    destination: '/app/estado',
                    body: JSON.stringify({ clientSessionId: sessionId })
                });
            };

            stompClient.activate();
        }
        
        // Función para liberar el cajero
        function liberarCajero() {
            const cajeroId = localStorage.getItem('cajeroId');
            
            if (cajeroId) {
                const data = new URLSearchParams();
                data.append('cajeroId', cajeroId);
                navigator.sendBeacon('/api/estado/cajero/liberar', data);
                
                localStorage.removeItem('cajeroId');
                localStorage.removeItem('cajeroNombre');
                console.log('Cajero liberado: ' + cajeroId);
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            conectarWebSocket();
        });

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('SW registrado:', registration.scope);
                })
                .catch(error => {
                    console.log('SW fallo:', error);
                });
        }
    </script>
</body>

</html>